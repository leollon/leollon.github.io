---
title: The-Transport-Layer
date: 2019-08-09 11:07:30
categories: Sams-Teach-yourself-TCP/IP-in-24-hours
tags: [notes, TCP/IP, Networks]
---

Transport layer用途：

- 给网络应用提供API
- 用于网络传输的可选的错误检查，流控制以及验证

本文目的在于：

- 描述传输层的基本职责
- 解释面向连接和无连接协议的异同
- 解释传输层如何通过ports以及sockets给网络应用提供接口
- 描述TCP以及UDP的异同
- 识别构成TCP header的字段
- 描述TCP如何打开开启并关闭连接
- 描述TCP如何序列并且通知数据传输
- 识别构成UDP header的四个字段

## Introducing the Transport Layer

TCP/IP开发者知道他们需要在能够与IP协作的网络层（Internet layer）上，通过提供额外的必要特性的另一层。
需要Transport layer protocol提供：

- 给网络应用提供接口：用于网络应用访问网络。需要能够将数据不仅仅是发送给目标计算机，还要将数据发送到目标计算机特定
的应用中。
- 多路复用/反多路复用：多路复用，意思是从不同的应用和计算机接收数据，并且指导数据到达接收计算机上的目标接收应用。
换句话说就是传输层能够不断地支持多个网络应用并且管理到网络层（Internet layer）的数据流。
接收端，传输层必须能够从网络层接受数据并且指导数据到多个应用中去。这一特性，称之为反多路服用，允许一台计算机不断地支持多个网络应用，比如浏览器，邮件客户端和文件分享工具。多路复用/反多路复用的另一方面是一个单独的应用能够连续地维护与多个计算机之间的连接。
- 错误检查，流控制以及验证：需要确保数据在发送和接受机器上传递的完整方案。

**Transmission COntrol Protocol (TCP)**: TCP 提供广泛的错误控制和流控制以及验证数据的成功传递。**TCP是面向连接的协议**。

**User Datagram Protocol (UDP)**: UDP提供及其基本的错误检查并且被设计用于没必要使用TCP广泛的控制特性的时
候。**UDP是一个无连接的协议**。

## Transport Layer Concepts

理解传输层的设计本质的几个重要概念：

- 面向连接和无连接协议
- Ports 和 Sockets
- 多路复用/反多路复用

## 面向连接和无连接协议

- 面向连接协议建立并维护通信计算机之间的连接并且通过传输线路监控连接的状态。换句话说，每个通过网络发送出去的数据包收到一个通知，并且发送机器记录状态信息来确保每个包没有错误地被收到，如果有必要，则重传。传输结束，发送端和接收端优雅地关闭连接。
- 无链接协议发送单向的数据报到目的计算机并且不操心通知目的计算机数据报在路上了。目的计算机接收到数据并且不操心返回
状态信息给源计算机。

面先连接协议的示意图：

![a02769e3bc074551.svg](https://i.quantuminit.com/a02769e3bc074551.svg)

无连接协议的示意图：

![c7237981b1d042f0.svg](https://i.quantuminit.com/c7237981b1d042f0.svg)

## Ports 和 Sockets

传输层在网络应用和网络之间提供一个接口并且提供传递数据到特定应用的方法。**Port**是预定义的内部地址，它作为从应用到
传输层或从传输层到应用的一条路径。例如，一台客户端通过TCP端口21与一个服务器的上FTP应用程序通信：

**Socket**是一个通过连接IP地址和端口(port)号码形成的一个地址。例如socket number 111.121.131.141:21关联到IP地址是111.121.131.141的计算机上的21端口。

计算机之间构成连接时，使用TCP交换socket 信息图示：

![3c677c9d9e2c418b.svg](https://i.quantuminit.com/3c677c9d9e2c418b.svg)

一台计算机通过一个socket访问一台目的计算机上应用的过程：

1. 计算机A通过已知的端口初始化一个连接计算机B上的应用程序的连接。一个**已知的端口**是一个有IANA分配给特定应用程
序的端口号码，IANA目前由ICANN管理。结合IP地址，这个已知端口成为计算机A的目的socket地址。这个请求包含告诉计算机B
当发送信息回计算机A时，要使用那个socket number的数据字段。这个就是计算机A的源socket address。

2. 计算机B通过已知端口收到来自计算机A请求并且响应和计算机A源地址列出来一样的socket。这个socket成为消息从计算机B的应用程序发送到计算机A的应用程序的目的地址。

已知的TCP端口：

![0a2e2f97a2b54fd3.png](https://i.quantuminit.com/0a2e2f97a2b54fd3.png)
![806adc354e5443a0.png](https://i.quantuminit.com/806adc354e5443a0.png)

已知的UDP端口：

![d10a759ae4254590.png](https://i.quantuminit.com/d10a759ae4254590.png)

## 多路复用/反多路复用

多路复用图例：

![418456e06e7f44e0.svg](https://i.quantuminit.com/418456e06e7f44e0.svg)

反多路复用图例：

![6482f7049b1d4d3b.svg](https://i.quantuminit.com/6482f7049b1d4d3b.svg)

多路复用/反多路复用使得TCP/IP协议栈的更底层能够处理数据而不用管是哪个应用初始化的。所有和原始应用的关联都在Transport layer进行设置，并且数据以单独，应用独立的管道传向或来自Internet Layer。

多路复用和反多路复用的关键是有IP地址和端口（port）号组成的socket地址，它提供了一个识别特定机器上特定应用程序的独
一无二的身份。

## Understanding TCP and UDP

开发网络应用可以选择使用TCP或UDP作为传输协议。UDP更简单的控制机制不应该成为考虑的限制。更少的通信质量保证并不意味
着更低的通信质量。TCP提供的额外的检查以及控制对于很多应用来说完全没必要。开发人员更喜欢在应用自身内部提供错误控制
以及流控制，能够根据特定需求进行自定义，并且更倾向于UDP传输用于网络访问。例如，应用层的Remote Procedure Call
(RPC) 协议能够支持复杂的应用，但是开发者有时候选择使用UDP作为传输层并且通过应用而不是通过降低连接速度的TCP来提供错误与流控制。

## TCP: 面向连接的传输层协议

TCP一些值得注意的一些特性：

- 面向流处理：TCP在流中处理数据。面向流处理意味TCP能够接收数据时一次能够接收一个字节而不是像预格式化的块。TCP格式化数据成能够传递给网络层的变长的段。
- 重新排序：假设目的地收到的数据是乱序的，TCP模块能够将数据进行排序恢复到原来的顺序。
- 流控制：TCP的流控制特性确保数据传输不会超过或超限目的机器能够接收的数据量。
- 先后顺序以及安全：国防部的TCP规范需要有用于设置TCP连接的可选的安全以及优先级等级。
- 优雅的连接关闭：TCP关心连接关闭就像打开连接一样关心。优雅的关闭特性确保所有的段在连接关闭之前，已经被发送并且接
受。

从[How TCP/IP works](/How-TCP-IP-works)中，可以知道分层协议系统比如TCP/IP通过交换在发送计算机给定层和接收
计算机相对应层之间信息来运转。换句话说，发送计算机上的网络接入层和读取数据帧的计算机的网络接入层进行通信。

回想起[What is TCP/IP](/What-is-TCP-IP)中的端结点负责验证TCP/IP上通信（端结点是那些实际上要进行通信的结点——
而不是转发消息的中间结点。）。

典型的网络互联的情况，数据由路由器从源子网传递到目的子网。

![a752a33da6784b02.svg](https://i.quantuminit.com/a752a33da6784b02.svg)

## TCP Data Format

TCP 数据格式图示

![d19083c8683f40c6.svg](https://i.quantuminit.com/d19083c8683f40c6.svg)

[上一篇](/Subnetting-and-CIDR)
[下一篇](/The-Application-Layer)
